- hosts: all
  become: true
  handlers:
    - name: systemd reload
      systemd:
        daemon_reload: yes
    - name: restart NetworkManager
      systemd:
        name: NetworkManager.service
        state: restarted
    - name: restart libvirtd
      systemd:
        name: libvirtd.service
        state: restarted
    - name: restart nfs-kernel-server
      systemd:
        name: nfs-kernel-server.service
        state: restarted
    - name: restart du_exporter service
      systemd:
        name: du_exporter.service
        state: restarted
        daemon_reload: yes
    - name: restart libvirt_exporter service
      systemd:
        name: libvirt_exporter.service
        state: restarted
        daemon_reload: yes
  tasks:
    - import_tasks: tasks/storage.yml
    - import_tasks: tasks/networking.yml
    - import_tasks: tasks/libvirt.yml
    - import_tasks: tasks/nfs.yml
    - import_tasks: tasks/cockpit.yml

- hosts: all
  become: true
  roles:
    - role: stefangweichinger.ansible_rclone
      vars:
        _rclone_password1: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          34346366333038623738303833336366656136656336336163636239643632613138643036616535
          6438643335346234346531633639613166353566353765650a393233323230353936306362643135
          66376337353036366239316531376564356539636535313231386533623533636331333039613761
          6230363566666466610a626564643665336435616539396136383739363333643937323539313565
          35303631356163336563343064366638656166303838663337303837343731656531383965393537
          61303162346330633830363665613433626664326433356534396665626334396436653738336231
          37663338626334333263333035633066623262636234303736313162383030626563373161653137
          37326361363534656537333365613832333464363131373963376537666138356465643865333463
          36313830616564396361623239636564353439343862633561613530626639663536653131313434
          30366634666236633636386366313065666463326632353064643534643765383636623661313636
          63393338373061333630333761356162633066303965316338653666383165313538663337346233
          39366233313532333639633431303162353533343632346634336334316661643566346361333730
          38316232386339386637356439636137633065313937306565323666356636313433333439616535
          39356635373731373238666238323365303930633934343339343130383133356265633639376633
          31626135666536323238613666363132393533626138333666653266396539303136363536633031
          32373934343439643930383963393461363462393539343139353033386362336636333965363736
          3762
        _rclone_password2: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          64353562663338336532663336396138346131306236393430613738366337623335663037326361
          6331346235666439343836616333376434303739333732370a366634626436373139633034336262
          39396438306264623762646364303362303838313139386333306138363637376435623362306533
          6461663638376464610a383863336365613733316465373061366539356263353566626530643131
          64343962323139356565313531303735303937333863366431343635363232333561393861646165
          35356163316235393538353161373466363130346463356163353930333533613133356563393833
          63323966316333336634633666636139303437656637616539633231353764303761323239653235
          34396339643162663866313536643437316263366634346539373834313630383165383332636133
          61383835616337656630383536646234633635343031646631393930323939626464633631336462
          30333037666661616631653463666132666262363134313663653333343132346362333662373531
          33323134666565393063383033376234366135633132373931633566393733646132336234663064
          63616464336363633234626661383237623034636635643834343630666363386534383266376663
          36383065623862663965303761336465653539303030356433373732363065613736396138663532
          62613532306230353130636238653532396637316634383032323663656638656563343635653264
          31323938303966373336323732336432663033656363623334376535343630336166383032366266
          38386432626366373265356533323662633039636331356364623863376437313432366166373066
          3231
        rclone_configs:
          - name: wasabi-use1
            properties:
              type: s3
              access_key_id: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                31333131643761363934393239323265303764623638343331383538303837316231303434346235
                6238656230353438303563306336656139313839376666340a396563623731646130636239626335
                62643061623762363438623333656464343638653736356239343232613663393963346536336663
                3630376338386264380a343735336131613132656439333665303063643138646265373034383662
                39623132343164376137623431313561363536346562623366626665326365333634
              secret_access_key: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                36653732373665666232616132646132393039633666623235363333633865656662353063323065
                6432333565386137323634373231313136636664333861660a643631383461373165653332363733
                38643363313961613330636338373534363361336264323630386262316462353034656234336236
                3065326363383033350a323535386564623735326162626666663863353131636164383836353536
                38306661313365333539313232373731393732313065356532666233396334323635656263313965
                3063303637663835336632393939333332623763333532313766
              region: us-east-1
              endpoint: s3.wasabisys.com
          - name: exos-archive
            properties:
              type: crypt
              remote: wasabi-use1:sapslaj-homelab-backups/exos-archive
              password: '{{ _rclone_password1 }}'
              password2: '{{ _rclone_password2 }}'
          - name: exos-media
            properties:
              type: crypt
              remote: wasabi-use1:sapslaj-homelab-backups/exos-media
              password: '{{ _rclone_password1 }}'
              password2: '{{ _rclone_password2 }}'
          - name: exos-volumes
            properties:
              type: crypt
              remote: wasabi-use1:sapslaj-homelab-backups/exos-volumes
              password: '{{ _rclone_password1 }}'
              password2: '{{ _rclone_password2 }}'
    - role: sapslaj.rclone_jobs
      vars:
        rclone_jobs:
          - name: exos-archive
            src: /mnt/exos/archive
            dest: 'exos-archive:'
          - name: exos-media
            src: /mnt/exos/Media
            dest: 'exos-media:'
          - name: exos-volumes
            src: /mnt/exos/volumes
            dest: 'exos-volumes:'
