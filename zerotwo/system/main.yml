- hosts: k3s_master
  become: true
  roles:
    - role: sapslaj.k3s_master
      vars:
        k3s_extra_server_args: --disable-helm-controller --disable traefik --write-kubeconfig-mode 644

- hosts: k3s_node
  become: true
  roles:
    - role: sapslaj.k3s_node
      vars:
        k3s_master_hostname: zerotwo.sapslaj.xyz
        k3s_token: '{{ hostvars["zerotwo.sapslaj.xyz"]["k3s_token"] }}'

- hosts: all
  become: true
  roles:
    - role: sapslaj.ipv6_shim
      vars:
        ipv6_shim_tcp_ports:
          - port: 80
          - port: 443
          - port: 6601
            state: absent
        ipv6_shim_udp_ports:
          - port: 5514
            state: absent

- hosts: k3s_master
  become: true
  tasks:
    - name: Install pip
      apt:
        name: python3-pip
        state: present
    - name: Install Python Kubernetes client
      pip:
        name: kubernetes
    # - name: Install helm-diff
    #   kubernetes.core.helm_plugin:
    #     plugin_path: https://github.com/databus23/helm-diff
    #     state: present
    # - name: Setup prometheus-community Helm repository
    #   kubernetes.core.helm_repository:
    #     name: prometheus-community
    #     repo_url: https://prometheus-community.github.io/helm-charts
    - name: Check if Prometheus Operator CRDs are installed
      kubernetes.core.k8s_info:
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        api_version: monitoring.coreos.com/v1
        kind: ServiceMonitor
      register: service_monitor_check
    # - name: Deploy Prometheus Operator CRDS
    #   kubernetes.core.helm:
    #     name: prometheus-operator-crds
    #     chart_ref: prometheus-community/prometheus-operator-crds
    #     create_namespace: true
    #     release_namespace: kube-system
    - name: Deploy Prometheus Operator CRDs
      kubernetes.core.k8s:
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        state: present
        definition: "{{ lookup('file', 'prometheus_operator_crds.yml') | from_yaml }}"
      when: not service_monitor_check.api_found
    - name: argocd namespace
      kubernetes.core.k8s:
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        state: present
        api_version: v1
        kind: Namespace
        name: argocd
    - name: check for argocd Application
      kubernetes.core.k8s_info:
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        api_version: argoproj.io/v1alpha1
        kind: Application
        name: argocd
        namespace: argocd
      register: argocd_application
    - name: install ArgoCD
      kubernetes.core.k8s:
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        state: present
        definition: "{{ lookup('kubernetes.core.kustomize', dir='../argocd/argocd') }}"
      when: not argocd_application.resources
    - name: ArgoCD GitHub credentials
      kubernetes.core.k8s:
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: github-sapslaj-ssh
            namespace: argocd
            labels:
              argocd.argoproj.io/secret-type: repo-creds
          stringData:
            type: git
            url: git@github.com:sapslaj
            sshPrivateKey: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              61636639656636333334623437663263363030353137333763366539626265653335636465653635
              6230303330306364383432633238623561626565303035370a353366363039653039393831653830
              66613332333766323337666164626435383164633863376162323865363432336137656161393031
              6431653235313066630a623461613936653335333338633730616139316436313965366434383036
              63353231313961326532353236393239353631396136613635663935336231623066633331613832
              33326666663734303861326665623064343236656432613333303032383164393764623161656132
              62366439663961316162366261373039666238393261343233366237366632643230653334666431
              35316466306266646233363666393532613663333464323866373363343835646265663333643138
              32376566643333366461653333646536643361393530353265613237366135653165646363616562
              66376634343931363962353032636162373136326633306439353330613039353833663139663166
              39333762353063663530643965323138363130653635616533376439393439383730653732366635
              34326337616233313564633562323633363265376264666566646336353333363832663039613539
              66393864306165383734626532613936343539313833663737336330646262346332626135646364
              31363431383130363664386132656365646532616263373831393130643166343065373532646438
              34356137306564326539623264396633373034346365303933613161643435653239313533633239
              65656661333632346637313334656639386239663761333762666239366233316162646134386466
              39376162373766656265383837333464633032633032383135383936653933623439653035323533
              38383438303464363166326635653438626664373031313135346230613137666537393333663330
              34336664323236323838663632376432623938316336646163396432316235383663393338303038
              39623031666464623033356561393830363461623466663733303361653162353331633333646532
              36626432373432383762643533303431376162373165623431323665623635623164376465396235
              34343062393463343331393037386230666333376137643332643963303933303465636262396161
              33313662623462646235316235616463353934323061393561393232626434336235323563393237
              31393138666338343137613830633563313331646532383236353763323436366538643738326631
              38633238376163633361643761643934373664323830633664306432323137623039343035643063
              33376366396439363562366639623934616330396634656439646662306665623137373963343730
              64333666306263363430363831613932393130613631613031353366326131393639623732306565
              36346634323932346434343538343463666234663134313430363537336230393831383566383439
              30396630656263366661333663626336366364323166636163393232623936643130396430656630
              38656237333361343065353831346361663766336662313033303638393539336338633262366263
              61376438303166393963383535373238346631336634663232623334386662633861363266303263
              32623161333939636666636464616532316264343566346666663731636562353634386464333265
              39306530303437613564666636643964643236363264336665626436656631666461303661643931
              62643737336463653930626665613137633438663130633031316165376364316662613866346566
              37636435613430313935393564633437303135396339613834353831306537633836316263343832
              34653963666234336637313837353632616539343765376661376537306266373462633563346562
              36366161316164393137393163653365373066663461386566366437356461366534623838386236
              31316131653065303937366339323137643062373564353465383962643134663630363737316566
              35653365656631356437643566383531623534663833633536636131636638363737303164303630
              32636137363634346134303632353631626330616664323537333066386663363239356131326534
              35393734613834383162646237306363643738373137623132646561343865303063633562336265
              30613032383466663963333765613335653861383865303032626131623964653133353030366563
              62323938626236363862636264336666643734316666356337353765323234373332663765613562
              64633266663232373432323132363538653137363232383363386239373365613437333539643464
              62323032343339323462323036653133343437636433386139626236373937323864326466656666
              32383264373035363662303834623664303338373336663635353036643934653065653936356237
              31323435656639653233373632316163393466333432653532393365306133316364356530363338
              33396239313134396237323966616530613634303665366533316365346236333731633531356266
              32616132643334646538356238396264313531336166323264353438366361326666386332363939
              33626265343264313666393833613366626665346662343963656434363865336564643766383935
              37343633663036323062333438626361613338613462396538313861643165663932303761336432
              39373162346235356539623064636438383434306430396636613834653562326436616536623339
              36663937653264343030383439366238653335303035653939653266303030353333363334656461
              33386165313237303330626666313839323063643435326330396238336132393634616563303238
              62366631373564306439343164646234376665326238393535323937633633383762376138653763
              61353134376139303534646534346365343761363264666532343035626362333438313061636635
              66373064663238376564373462663661333830336236613963666136653237373330373062626439
              34633565373332656261666430343736623665323534656464613130653335386565616431623137
              61626136646363356530326134393031313239373465343533633637663136393831613230386636
              31363461353032316663393565363062643661303363323164373761363065633139663838616362
              66303662373139346530333737346661376339636562646666333965613634343165666264396466
              37613365663731333262303730636139633234663861636163346535313866633862386539363662
              32343430373739383766383230363832646162643061306631303138336261376162663331383534
              37626231633338653366343136383238306635653131323862393265613831383933616164303236
              63663163333061333530663235306233326232386465333963353164303766643338353336363839
              38633536306264613237373839346466383930346233343266316231373637336634386561353334
              62373638656261316330633132306637323361666436663365393766653262326465633162386365
              63383734313330343835396137646362613537336363383937613134353261353931316661343662
              62383939656562626261356635613730376636633032333336396339646534326264326465653862
              64353161613339616466653030646136626433663433376235303361666636633431633838363736
              62383266326530616430386632623336653863363733623838623239646233316161373638353231
              34316264636562333434323435353139396566666630663335326331333165653036393862303465
              63386339343961373465633431633836663234363831306337316436666163366464343665656262
              62383830653361666365356239653766343834386539653732346262353562383735626339386366
              32373065353961373661333361383065356132623834646465336336636163663963333564303531
              39323035643665343431663835656430346430373066393731633431383739623265333461303165
              31376430366231353936623035613535326566653535386333363335313634396563313162336431
              64663239626631316130353366323439633063376465613837333932306363316534333838336338
              37663232353731373834663561336563333836636536353334346139313435623536303232383764
              39356339313731306234336339646232656666356234333736646463363538343535666462633037
              36386266643135316432336336343561313166656635613733383065633636356465643430386333
              63623130616264663733613636313737663032646232356666306666333838356637623966363030
              66333539386531666530653364646332346634623066643663663832653238366230323031346662
              35326238616438653662353832646539333231343233303736353465303931373466393464613933
              32623734623834616332656239303261643634383033336666646632333837623335336336353664
              32383265613732623936333763663134613166636364386338333264626234323036313037346433
              65653835366362316232636330353531366562376238373361333036643434613435343031376338
              38653933643538323638373961393134313764313364393061623132303939353930383164373863
              32383439653632373665386332313339316637303730313161633462396234323463636562393730
              35393838643663383730353766646362663466383266336538303665376364623161373439346536
              61653331396265346463626362333661613430353530373965616534303764346131323738653065
              62323231313063353163356536306666383632386430356135306638663233663564386337363932
              62616564306332626363653838326664323634653833386261353462383965303939336439663665
              34653139646163363362636535613566623532366363656564373137373365663934633934653061
              31383136613330393865303634316239666530643763653461333135306264303035336138636532
              63313437323036343965316435323464616438323236363736333431373738613137626332643261
              32366165626633326134666239356236623732386262633931653161343938626662326236353832
              30343461373365613630626165343839346561356335376634656539303564396166653139363639
              66313535613330346234346136376234336161343539666163366333633631306335653436343538
              64383435633334313539616632303236303066653863313833316632383839393763333065363234
              34396264356137353263633161376330303766613733313064643463326439306365626661613531
              37613862316262633633623866343634396131356235336139353865363634663131326361336334
              64333437666439653832343461326130363834373439393164306163396130393932623330306531
              32626634333433343832363936393438633739613332323838626233653364656261356539623037
              36653734336536633165336135666535306230386337656261333165306434323436313366336637
              62613132396532643064633166313364643932663263393638373931303831393737613435646366
              61383364353235393038616561616264303164356339313735643530313636326264623538653737
              35333532303766306634616464306462633039323634643966313432333564643136656230616663
              38626465363466656161336334633863623661386433653539393939333431653434623135366563
              31323738656238396337343136333336383337653965646139336436623434363535313134646236
              36663034393039343036326661623431373330643735343730313764376535316564393434383061
              39343636663762323134393832653930386434396362666336326662366632666561666132396561
              34313738383533313630613335376561363465313732363638663035623265313336643539383837
              31313434323231393962666561316439333763316135316134383064323839373830333331393936
              39393365653762613066323162333235366530666234663236343132646637613461663362386363
              63363538353264333266306530643863316262376437306638626336666563313532333037383339
              30326632323930323231373862626363646233663733633763373464306162383631656133646632
              30313035343033376364316236356564326237653033363666643335396537373339363234656330
              37633231383333306162313234303864643663666634663466663263353236386536333337363235
              32383763643864663665386363343063353435656233653235666339316231336135376566333932
              37636634633561336233383237333063663762643566396535653665353436646362363961366235
              39616662626661373932333136373661616333306234363538323033313765366437333062613535
              36303437323563383437343666396132373737373235366436393736323633336139386261326138
              66653265386262656539613463316230353361316537336332316133346231396539636537366633
              35613665393937393261386233353132303834373236373966666330343562383034346362646364
              61643730646139623535623330313833366134646631376531663430363631303862623866613036
              38326161306432626264616135653865356438663764633864376238636365343965313731643333
              63363533353664373637363430383337353637653865326433356465336531613863346535373431
              61376535623137653636663137666333653132353162326565623962366433343230636163656162
              33323538353335346230383463613233636531313566353437313432643831353163343362373463
              30663932616433393465316530336234346331323434663532366133656264313536383263363630
              62363164313565643038306636393539376464393634306163653565346338306262613530303163
              64646536303964636566633832356532393262366236353362306130323235613766646261313238
              65386664313933613565626431306662316233623061396264653465306664653635343964656166
              356237346631343034356564626263383565
